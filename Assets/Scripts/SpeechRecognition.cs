using Microsoft.CognitiveServices.Speech;
using System.Diagnostics;
using System.Threading.Tasks;
using Unity.VisualScripting;
using UnityEngine;

public class SpeechRecognition : MonoBehaviour
{
    private string speechKey = "39cf770484cc49a88518708648e11238";
    private string serviceRegion = "koreacentral";
    
    public GameObject DogGum;
    public GameObject clone;
    Corgi corgi;

    private void Awake()
    {
        corgi = GetComponent<Corgi>();
    }

    private async void Start()
    {
        await RecognizeSpeechAsync();
    }

    private async Task RecognizeSpeechAsync()
    {
        var config = SpeechConfig.FromSubscription(speechKey, serviceRegion);
        using (var recognizer = new SpeechRecognizer(config))
        {
            while (true) 
            {
                var result = await recognizer.RecognizeOnceAsync();

                if (result.Reason == ResultReason.RecognizedSpeech)
                {
                    UnityEngine.Debug.Log($"음성인식 결과: {result.Text}");

                    doAction(result.Text);
                }
                else if (result.Reason == ResultReason.NoMatch)
                {
                    UnityEngine.Debug.Log($"인식불가");
                }
                else if (result.Reason == ResultReason.Canceled)
                {
                    var cancellation = CancellationDetails.FromResult(result);
                    UnityEngine.Debug.Log($"취소 => {cancellation.Reason}");

                    if (cancellation.Reason == CancellationReason.Error)
                    {
                        UnityEngine.Debug.Log($"취소: ErrorCode={cancellation.ErrorCode}");
                        UnityEngine.Debug.Log($"취소: ErrorDetails={cancellation.ErrorDetails}");
                        UnityEngine.Debug.Log($"취소: 구독정보 갱신");
                    }
                }
            }
        }
    }

    // 인식된 음성에 따른 행동
    public void doAction(string msg)
    {
        switch(msg)
        {
            case "Sit.":
                UnityEngine.Debug.Log("Action : Sit");
                corgi.cState = Corgi.state.Sit;
               
                corgi.doSit();
                break;

            case "Eat.":
                UnityEngine.Debug.Log("Action : Eat");
                corgi.cState = Corgi.state.Eat;
                corgi.doEat();

                Destroy(clone);
                break;

            case "Turn.":
                UnityEngine.Debug.Log("Action : Turn");
                corgi.cState = Corgi.state.Turn;
                
                corgi.doTurn();
                break;

            case "Happy.": // 이름 부름 -> 쳐다봄
                UnityEngine.Debug.Log("Action : Look");
                corgi.cState = Corgi.state.Look;
               
                corgi.doLook();
                break;

            case "Stand up.": // 일어나!

                UnityEngine.Debug.Log("Action : Sit UP");
                corgi.cState = Corgi.state.SitUp;

                corgi.doSitUp();
                break;

            case "Bone.": // 뼈 생성
                UnityEngine.Debug.Log("Create : Bone");
                clone = Instantiate(DogGum, new Vector3(0, 0, 0), DogGum.transform.rotation);
                clone.SetActive(true);

                break;
        }
    }

    
}
